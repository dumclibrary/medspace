image: docker:git

stages:
  - test
  - build
  - deploy

variables:
  MEDSPACE_IMAGE: $CI_REGISTRY/mclibrary/medspace
  FCREPO_IMAGE: $CI_REGISTRY/mclibrary/medspace/fcrepo
  SOLR_IMAGE: $CI_REGISTRY/mclibrary/medspace/solr

test:
  stage: test
  image: $CI_REGISTRY/mclibrary/medspace
  services:
    - redis:3-alpine
    - $CI_REGISTRY/mclibrary/medspace/solr
    - $CI_REGISTRY/mclibrary/medspace/fcrepo
  variables:
    REDIS_HOST: redis
    FCREPO_URL: http://$CI_REGISTRY-mclibrary-medspace-fcrepo:8080
    SOLR_URL: http://$CI_REGISTRY-mclibrary-medspace-solr:8983/solr/medspace
  script:
    - bundle install
    - bundle exec rspec

medspace_deploy:
  image: $CI_REGISTRY/mclibrary/medspace
  stage: deploy
  before_script:
    - echo "$ANSIBLE_VAULT_FILE" > ansible/group_vars/all/vault.yml
  script:
   - bin/bundle install
   - bin/rails assets:precompile RAILS_ENV=production DEVISE_SECRET_KEY=secret
   - cd ansible && ansible-playbook -i inventory deploy_medspace.yml
  tags:
    - deploy
  only:
    - master
  except:
    - schedules
  when: manual
  environment:
    name: staging
    url: https://dev-medspace.mc.duke.edu

medspace_build:
  stage: build
  services:
    - docker:dind
  before_script:
    - docker login -u gitlab-ci-token -p $CI_BUILD_TOKEN $CI_REGISTRY
  script:
    - docker build -t $MEDSPACE_IMAGE .
    - docker push $MEDSPACE_IMAGE
  tags:
    - docker
  only:
    - schedules

fcrepo_build:
  stage: build
  services:
    - docker:dind
  before_script:
    - docker login -u gitlab-ci-token -p $CI_BUILD_TOKEN $CI_REGISTRY
  script:
    - docker build -t $FCREPO_IMAGE docker-fcrepo
    - docker push $FCREPO_IMAGE
  tags:
    - docker
  only:
    - schedules

solr_build:
  stage: build
  services:
    - docker:dind
  before_script:
    - docker login -u gitlab-ci-token -p $CI_BUILD_TOKEN $CI_REGISTRY
  script:
    - docker build -t $SOLR_IMAGE solr
    - docker push $SOLR_IMAGE
  tags:
    - docker
  only:
    - schedules