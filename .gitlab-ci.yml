image: docker:git

stages:
  - mirror
  - test
  - build
  - deploy

variables:
  MEDSPACE_IMAGE: $CI_REGISTRY/mclibrary/medspace
  FCREPO_IMAGE: $CI_REGISTRY/mclibrary/medspace/fcrepo
  SOLR_IMAGE: $CI_REGISTRY/mclibrary/medspace/solr

github_mirror:
  stage: mirror
  allow_failure: true
  script:
    - cd /tmp
    - git clone --bare $CI_REPOSITORY_URL
    - cd medspace.git
    - git push --mirror https://$GITHUB_TOKEN@github.com/dumclibrary/medspace.git

test:
  stage: test
  image: $CI_REGISTRY/mclibrary/medspace
  services:
    - redis:3-alpine
    - $CI_REGISTRY/mclibrary/medspace/solr
    - $CI_REGISTRY/mclibrary/medspace/fcrepo
  variables:
    REDIS_HOST: redis
    FCREPO_URL: http://$CI_REGISTRY-mclibrary-medspace-fcrepo:8080
    SOLR_URL: http://$CI_REGISTRY-mclibrary-medspace-solr:8983/solr/medspace
  script:
    - bundle install
    - bundle exec rspec

assets_precompile:
  image: $CI_REGISTRY/mclibrary/medspace
  stage: build
  script:
    - bin/rails assets:precompile RAILS_ENV=production DEVISE_SECRET_KEY=secret
  cache:
    key: "$CI_COMMIT_REF_NAME"
    policy: push
    paths:
      - public

medspace_build:
  stage: build
  services:
    - docker:dind
  before_script:
    - docker login -u gitlab-ci-token -p $CI_BUILD_TOKEN $CI_REGISTRY
  script:
    - docker build -t $MEDSPACE_IMAGE .
    - docker push $MEDSPACE_IMAGE
  tags:
    - docker
  only:
    - master

fcrepo_build:
  stage: build
  services:
    - docker:dind
  before_script:
    - docker login -u gitlab-ci-token -p $CI_BUILD_TOKEN $CI_REGISTRY
  script:
    - docker build -t $FCREPO_IMAGE docker-fcrepo
    - docker push $FCREPO_IMAGE
  tags:
    - docker
  only:
    - master

solr_build:
  stage: build
  services:
    - docker:dind
  before_script:
    - docker login -u gitlab-ci-token -p $CI_BUILD_TOKEN $CI_REGISTRY
  script:
    - docker build -t $SOLR_IMAGE solr
    - docker push $SOLR_IMAGE
  tags:
    - docker
  only:
    - master

medspace_deploy:
  stage: deploy
  before_script:
    - apk --no-cache add ansible openssh-client rsync
    - echo "$ANSIBLE_VAULT_FILE" > ansible/group_vars/all/vault.yml
  script:
    - cd ansible && ansible-playbook -i inventory deploy_medspace.yml
  tags:
    - deploy
#  only:
#    - master
  when: manual
  environment:
    name: staging
    url: https://dev-medspace.mc.duke.edu
  cache:
    key: "$CI_COMMIT_REF_NAME"
    policy: pull
    paths:
      - public